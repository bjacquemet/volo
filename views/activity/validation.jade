extends ../layout

block content
  -function format_date(date){
  - var newDate = new Date(date);
  - var y = newDate.getFullYear();
  - var month = new Array(); 
  - month[0] = '01';
  - month[1] = '02';
  - month[2] = '03';
  - month[3] = '04';
  - month[4] = '05';
  - month[5] = '06';
  - month[6] = '07';
  - month[7] = '08';
  - month[8] = '09';
  - month[9] = '10';
  - month[10] = '11';
  - month[11] = '12'; 
  - var m = month[newDate.getMonth()];
  - var d = newDate.getDate();
  - if (d <10) d= '0'+d;
  - return m+'/'+d+'/'+y;
  -}
  -function plurialize(number){
  -if (number == 1) return number + ' hour'
  -else return number + ' hours'
  -}
  -function lowerToCapitalize(str){
  -return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
  -}

  script(src="//cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js")

  div.container-fluid
    div.row.row-centered
      div.col-md-10.col-md-offset-1.col-xs-12.content
        .col-md-12.col-sm-12.col-xs-12
          if (authorized == false)
            h4.col-md-12.text-center 
              |You are not authorized to access this page
            p 
              |Please verify that you have the right link to this page. First check the email you received for validating volunteer experiences and contact 
              a(href="mailto:melissa@volo.org.uk") melissa@volo.org.uk
              |&nbsp;if you have any problem.
          else if (activities.length == 0)
            h4.col-md-12.text-center 
              |No validation pending
              br
              |Thanks for your help in making VOLO a success
          else
            h3 Volunteering experience validation
            p
              |Here is the list of experiences volunteers have had with your nonprofit.
              br
              |Please, we'd appreciate if you could take the time to accept these experiences if they are correct 
              |or decline them if they did not happen.
            .col-md-12.break
            each activity in activities
              .col-md-12.col-sm-12.col-xs-12.validation_pending
                .col-md-1.col-sm-1.col-xs-12.user-md.text-center
                  -if (activity.volunteer.photo.cropedPath)
                    img(src="#{activity.volunteer.photo.cropedPath}")
                  -else
                    img(src="#{activity.volunteer.photo.originalPath}")
                .col-md-8.col-sm-8.col-xs-12
                  a(href="/volunteer/#{activity.volunteer._id}", target="_blank")
                    p.volunteer_name #{activity.volunteer.first_name} #{activity.volunteer.last_name} 
                  - if (activity.volunteer.position == 'student' && activity.volunteer.university)
                    p <em>#{capitalize(activity.volunteer.position)} at #{activity.volunteer.university.name}</em>
                  - else if (activity.volunteer.position == 'student' && !activity.volunteer.university)
                    p <em>#{capitalize(activity.volunteer.position)}</em>
                  - else if (activity.volunteer.position == 'employed' && activity.volunteer.company)
                    p <em>#{capitalize(activity.volunteer.position)} at #{activity.volunteer.company}</em>
                  - else if (activity.volunteer.position == 'employed' && !activity.volunteer.company)
                    p <em>#{capitalize(activity.volunteer.position)}</em>
                  - else
                    p <em>#{activity.volunteer.position}</em>
                  p 
                    |Volunteered on the <em>#{format_date(activity.start_date)}</em> during <em>#{plurialize(activity.hours)}</em> as 
                    em #{lowerToCapitalize(activity.role.name)}

                  - if (activity.skills.length > 0)
                    p Skills acquired: 
                      each skill, i in activity.skills
                        em
                          if (i == 0)
                            span #{lowerToCapitalize(skill.name)}
                          else
                            span , #{lowerToCapitalize(skill.name)}
                .col-md-3.col-sm-3.col-xs-12.text-center
                  a(href="#", class="btn sharp btn-lg btn-primary first-btn btn-validate", data-toggle="modal", data-target="#acceptModal", data-response="accept", data-activity="#{activity._id}" data-referee="#{activity.referee.name}") Accept
                  a(href="#", class="btn sharp btn-lg btn-default btn-validate btn-decline", data-toggle="modal", data-target="#declineModal", data-response="decline", data-activity="#{activity._id}",) Decline
            

            .modal.fade#declineModal(tabindex='-1')
              .modal-dialog
                .modal-content
                  .modal-header
                    button(type="button" class="close" data-dismiss="modal") &times;
                    p Decline volunteer experience
                  .modal-body
                    p Please, explain us why you decline this experience. This won't be public.
                    form(id="declineForm", action="/activity/decline", method="post", class="text-center")
                      input(type="hidden", name="activityId", class="activityId")
                      textarea.col-md-12(name="declineReason", rows="2")
                      input(type="submit", value="Decline experience", name="submit", class="btn btn-primary sharp modal-submit")

            .modal.fade#acceptModal(tabindex='-1')
              .modal-dialog
                .modal-content
                  .modal-header
                    button(type="button" class="close" data-dismiss="modal") &times;
                    p Reccomend volunteer
                  .modal-body
                    p Thanks for accepting this experience. Do you also want to add a recommendation to this volunteer? This will be public on his profile.
                    form(id="recoForm", action="/activity/accept", method="post", class="text-center")
                      input(type="hidden", name="activityId", class="activityId")
                      input(type="hidden", name="referee", class='referee')
                      textarea.col-md-12(name="recommendation", rows="2", required)
                      input(type="submit", value="Add recommendation", name="submit", class="btn btn-primary modal-submit")
                    form(id="acceptForm", action="/activity/accept", method="post", class="text-center")
                      input(type="hidden", name="activityId", class="activityId")
                      input(type="hidden", name="referee", class='referee')
                      input(type="submit", value="No thanks", class="btn btn-default modal-submit")

      script.
        $(document).ready(function() {
          $(".btn-validate").on('click', function () {
            var activityID = $(this).data('activity');
            var referee = $(this).data('referee');
            $(".referee").val(referee);
            $(".activityId").val(activityID);
          });

          $('.btn-decline').on('click', function () {
            var activityID = $(this).data('activity');
            $(".activityId").val(activityID);
          });

          //- $('.modal form').on('submit', function (e) {
          //-   e.preventDefault();
          //-   location.reload();
          //- })

          $('#acceptModal form').submit(function(event) {
            event.preventDefault();
            $(this).ajaxSubmit({
              error: function(xhr) {
                console.log(xhr);
              },
              success: function(response) {
                location.reload();
              }
            });
          });

          $('#declineModal form').submit(function(event) {
            event.preventDefault();
            $(this).ajaxSubmit({
              error: function(xhr) {
                console.log(xhr);
              },
              success: function(response) {
                location.reload();
              }
            });
          });
        });
        